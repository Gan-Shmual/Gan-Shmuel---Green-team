{% extends "layout.html" %}
{% block title %}Billing Summary{% endblock %}

{% block content %}

<div class="max-w-4xl mx-auto">
  <div class="bg-white rounded-xl shadow-lg p-6 mb-6">

    <h2 class="text-2xl font-bold text-gray-800 mb-4">
      Billing Summary
    </h2>

    <!-- Provider ID + Dates -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="text-sm text-gray-600">Provider ID</label>
        <input id="providerId" type="text"
               class="w-full border rounded p-2" placeholder="1">
      </div>

      <div>
        <label class="text-sm text-gray-600">From</label>
        <input id="fromTime" type="datetime-local"
               class="w-full border rounded p-2">
      </div>

      <div>
        <label class="text-sm text-gray-600">To</label>
        <input id="toTime" type="datetime-local"
               class="w-full border rounded p-2">
      </div>
    </div>

    <button onclick="loadBilling()"
            class="mt-4 bg-primary text-white px-4 py-2 rounded shadow hover:bg-blue-700">
      Load Billing
    </button>
  </div>

  <!-- Billing Results -->
  <div id="billingResult" class="hidden bg-white rounded-xl shadow-lg p-6">
    <h3 class="text-xl font-bold mb-3">Summary</h3>

    <div class="grid grid-cols-2 gap-6 mb-4">
      <div>
        <p class="text-sm text-gray-500">Provider</p>
        <p id="resProvider" class="font-bold text-gray-800">--</p>
      </div>
      <div>
        <p class="text-sm text-gray-500">Total</p>
        <p id="resTotal" class="font-bold text-green-600 text-lg">-- ₪</p>
      </div>

      <div>
        <p class="text-sm text-gray-500">Truck Count</p>
        <p id="resTruckCount" class="font-mono text-gray-800">--</p>
      </div>

      <div>
        <p class="text-sm text-gray-500">Session Count</p>
        <p id="resSessionCount" class="font-mono text-gray-800">--</p>
      </div>
    </div>

    <h3 class="text-lg font-semibold mb-2">Products</h3>

    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
            Product
          </th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
            Count
          </th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
            Amount
          </th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
            Rate
          </th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
            Pay
          </th>
        </tr>
      </thead>
      <tbody id="billingTable" class="divide-y divide-gray-200"></tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
async function loadBilling() {
    const id = document.getElementById("providerId").value.trim();
    if (!id) {
        showNotification("Error", "Provider ID missing", "error");
        return;
    }

    const from = document.getElementById("fromTime").value.replace(/[-T:]/g, "") + "00";
    const to = document.getElementById("toTime").value.replace(/[-T:]/g, "") + "00";

    const url = `/bill/${id}?from=${from}&to=${to}`;

    try {
        const res = await fetch(url);
        const data = await res.json();

        if (!res.ok) {
            showNotification("Error", data.error, "error");
            return;
        }

        document.getElementById("billingResult").classList.remove("hidden");

        document.getElementById("resProvider").textContent = `${data.id} - ${data.name}`;
        document.getElementById("resTotal").textContent = data.total + " ₪";
        document.getElementById("resTruckCount").textContent = data.truckCount;
        document.getElementById("resSessionCount").textContent = data.sessionCount;

        const table = document.getElementById("billingTable");
        table.innerHTML = "";

        data.products.forEach(p => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="px-4 py-2">${p.product}</td>
                <td class="px-4 py-2">${p.count}</td>
                <td class="px-4 py-2">${p.amount}</td>
                <td class="px-4 py-2">${p.rate}</td>
                <td class="px-4 py-2 font-bold">${p.pay}</td>
            `;
            table.appendChild(tr);
        });

        showNotification("Success", "Billing loaded", "success");

    } catch (e) {
        showNotification("Error", e.message, "error");
    }
}
</script>
{% endblock %}
