{% extends "layout.html" %} {% block title %}Health Status - Weight Service{%
endblock %} {% block content %}

<div class="max-w-4xl mx-auto">
  <div
    class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"
  >
    <!-- Header -->
    <div
      class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50"
    >
      <div>
        <h2 class="text-xl font-bold text-gray-800">System Health Status</h2>
        <p class="text-sm text-gray-500 mt-1">
          Real-time monitoring of service components
        </p>
      </div>
      <button
        id="refresh-health"
        class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium py-2 px-4 rounded-lg shadow-sm transition-all duration-200 flex items-center"
      >
        <i class="fas fa-sync-alt mr-2 text-primary"></i> Refresh
      </button>
    </div>

    <!-- Status Grid -->
    <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Weight Service -->
      <div
        class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow"
      >
        <div class="flex items-center justify-between mb-4">
          <div class="p-3 bg-blue-50 rounded-full">
            <i class="fas fa-server text-primary text-xl"></i>
          </div>
          <span
            id="weight-service-badge"
            class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full font-semibold"
            >Checking</span
          >
        </div>
        <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">
          Weight Service
        </h3>
        <p
          id="weight-service-status"
          class="text-2xl font-bold text-gray-800 mt-1"
        >
          ...
        </p>
      </div>

      <!-- Database -->
      <div
        class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow"
      >
        <div class="flex items-center justify-between mb-4">
          <div class="p-3 bg-indigo-50 rounded-full">
            <i class="fas fa-database text-indigo-600 text-xl"></i>
          </div>
          <span
            id="database-badge"
            class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full font-semibold"
            >Checking</span
          >
        </div>
        <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">
          Database
        </h3>
        <p id="database-status" class="text-2xl font-bold text-gray-800 mt-1">
          ...
        </p>
      </div>

      <!-- API Response -->
      <div
        class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow"
      >
        <div class="flex items-center justify-between mb-4">
          <div class="p-3 bg-green-50 rounded-full">
            <i class="fas fa-network-wired text-green-600 text-xl"></i>
          </div>
          <span
            id="storage-badge"
            class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full font-semibold"
            >Checking</span
          >
        </div>
        <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">
          API Latency
        </h3>
        <p id="storage-status" class="text-2xl font-bold text-gray-800 mt-1">
          ...
        </p>
      </div>
    </div>

    <!-- Footer Info -->
    <div
      class="bg-gray-50 p-4 border-t border-gray-100 flex justify-between text-xs text-gray-500"
    >
      <span
        >Last Checked:
        <span id="last-check" class="font-medium">Never</span></span
      >
      <span
        >Uptime:
        <span id="system-uptime" class="font-mono">00:00:00</span></span
      >
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const refreshButton = document.getElementById("refresh-health");

    function updateCard(type, isHealthy, message) {
      const statusEl = document.getElementById(`${type}-status`);
      const badgeEl = document.getElementById(`${type}-badge`);

      statusEl.textContent = message;

      if (isHealthy) {
        badgeEl.className =
          "px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-semibold";
        badgeEl.textContent = "ONLINE";
        statusEl.className = "text-2xl font-bold text-gray-800 mt-1";
      } else {
        badgeEl.className =
          "px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full font-semibold";
        badgeEl.textContent = "OFFLINE";
        statusEl.className = "text-2xl font-bold text-red-600 mt-1";
      }
    }

    function checkHealth() {
      const startTime = performance.now();

      // FIX: Use /api/health instead of /health
      fetch("/api/health")
        .then((response) => {
          const latency = Math.round(performance.now() - startTime) + "ms";
          if (!response.ok) throw new Error("Health check failed");
          return response.text().then((text) => ({ text, latency }));
        })
        .then((data) => {
          const isHealthy = data.text === "OK";

          updateCard(
            "weight-service",
            isHealthy,
            isHealthy ? "Operational" : "Error"
          );
          updateCard(
            "database",
            isHealthy,
            isHealthy ? "Connected" : "Disconnected"
          );
          updateCard("storage", true, data.latency); // Using storage card for latency

          document.getElementById("last-check").textContent =
            new Date().toLocaleTimeString();

          if (!isHealthy) {
            showNotification(
              "Warning",
              "System health issues detected",
              "warning"
            );
          } else {
            // Optional: show success toast only on manual refresh
            // showNotification("Healthy", "System is operational", "success");
          }
        })
        .catch((error) => {
          updateCard("weight-service", false, "Unreachable");
          updateCard("database", false, "Unknown");
          updateCard("storage", false, "Timeout");

          showNotification("Error", "Failed to contact server", "error");
          console.error("Health check error:", error);
        });
    }

    // Initial check
    checkHealth();
    refreshButton.addEventListener("click", checkHealth);

    // Uptime counter
    let uptimeSeconds = 0;
    setInterval(() => {
      uptimeSeconds++;
      const date = new Date(0);
      date.setSeconds(uptimeSeconds);
      document.getElementById("system-uptime").textContent = date
        .toISOString()
        .substr(11, 8);
    }, 1000);
  });
</script>
{% endblock %}
