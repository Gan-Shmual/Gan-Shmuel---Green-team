{% extends "layout.html" %} {% block title %}Batch Upload - Weight Service{%
endblock %} {% block content %}
<div class="max-w-3xl mx-auto">
  <div class="bg-white rounded-xl shadow-lg overflow-hidden">
    <div class="bg-slate-800 p-6 text-white">
      <h2 class="text-2xl font-bold flex items-center">
        <i class="fas fa-file-upload mr-3 text-primary"></i> Batch Container
        Upload
      </h2>
      <p class="text-gray-400 text-sm mt-1">
        Upload a file to register multiple container weights at once.
      </p>
    </div>

    <div class="p-8">
      <!-- Instructions -->
      <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-8">
        <div class="flex">
          <div class="flex-shrink-0">
            <i class="fas fa-info-circle text-blue-500"></i>
          </div>
          <div class="ml-3">
            <p class="text-sm text-blue-700 font-bold">
              Accepted File Formats:
            </p>
            <ul class="list-disc list-inside text-sm text-blue-600 mt-1">
              <li><strong>CSV (kg):</strong> <code>id, kg</code></li>
              <li><strong>CSV (lbs):</strong> <code>id, lbs</code></li>
              <li>
                <strong>JSON:</strong>
                <code>[{"id":"C1", "weight":100, "unit":"kg"}, ...]</code>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Upload Form -->
      <form id="batchForm" class="space-y-6">
        <div
          class="flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:bg-gray-50 transition-colors"
          id="dropZone"
        >
          <div class="space-y-1 text-center">
            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
            <div class="flex text-sm text-gray-600 justify-center">
              <label
                for="file-upload"
                class="relative cursor-pointer bg-white rounded-md font-medium text-primary hover:text-blue-500 focus-within:outline-none"
              >
                <span>Upload a file</span>
                <input
                  id="file-upload"
                  name="file"
                  type="file"
                  class="sr-only"
                  accept=".csv,.json"
                />
              </label>
              <p class="pl-1">or drag and drop</p>
            </div>
            <p class="text-xs text-gray-500" id="fileName">No file selected</p>
          </div>
        </div>

        <button
          type="submit"
          class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <i class="fas fa-upload mr-2"></i> Process Batch
        </button>
      </form>

      <!-- Progress/Result Area -->
      <div id="resultArea" class="hidden mt-6">
        <div
          id="successMsg"
          class="hidden p-4 bg-green-50 rounded-md border border-green-200"
        >
          <div class="flex">
            <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-green-800">
                Upload Successful
              </h3>
              <div class="mt-2 text-sm text-green-700">
                <p>The file has been processed successfully.</p>
              </div>
            </div>
          </div>
        </div>

        <div
          id="errorMsg"
          class="hidden p-4 bg-red-50 rounded-md border border-red-200"
        >
          <div class="flex">
            <i class="fas fa-exclamation-circle text-red-500 mt-0.5"></i>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">Upload Failed</h3>
              <p class="mt-2 text-sm text-red-700" id="errorText">
                Unknown error occurred.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  const fileInput = document.getElementById("file-upload");
  const fileNameDisplay = document.getElementById("fileName");

  // Update filename on selection
  fileInput.addEventListener("change", (e) => {
    if (e.target.files.length > 0) {
      fileNameDisplay.textContent = e.target.files[0].name;
      fileNameDisplay.classList.add("text-primary", "font-bold");
    } else {
      fileNameDisplay.textContent = "No file selected";
      fileNameDisplay.classList.remove("text-primary", "font-bold");
    }
  });

  document.getElementById("batchForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    if (fileInput.files.length === 0) {
      showNotification("Error", "Please select a file first", "error");
      return;
    }

    const btn = e.target.querySelector("button");
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    btn.disabled = true;

    // Hide previous results
    document.getElementById("resultArea").classList.remove("hidden");
    document.getElementById("successMsg").classList.add("hidden");
    document.getElementById("errorMsg").classList.add("hidden");

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    try {
      const res = await fetch("/api/batch-weight", {
        method: "POST",
        body: formData,
      });

      if (res.ok) {
        document.getElementById("successMsg").classList.remove("hidden");
        showNotification("Success", "Batch processed successfully", "success");
        // Reset form
        document.getElementById("batchForm").reset();
        fileNameDisplay.textContent = "No file selected";
      } else {
        const data = await res.json(); // Try to get JSON error
        throw new Error(data.error || "Server returned an error");
      }
    } catch (err) {
      document.getElementById("errorMsg").classList.remove("hidden");
      document.getElementById("errorText").textContent = err.message;
      showNotification("Error", "Upload failed", "error");
    } finally {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  });
</script>
{% endblock %}
