{% extends "layout.html" %}
{% block title %}Production Monitor Dashboard{% endblock %}

{% block extra_head %}
<style>
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .indicator {
    animation: pulse 2s infinite;
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">

  <!-- Page Header -->
  <div class="mb-6">
    <h2 class="text-3xl font-bold text-gray-800">
      <i class="fas fa-chart-line text-green-600 mr-2"></i>
      Production Monitor Dashboard
    </h2>
    <p class="text-gray-600 mt-2">Real-time health monitoring for all services</p>
  </div>

  <!-- Overall Status Summary -->
  <div id="summary" class="bg-white rounded-xl shadow-lg p-6 mb-6 border-l-4">
    <h3 class="text-xl font-bold text-gray-700 mb-2">Loading...</h3>
  </div>

  <!-- Action Buttons -->
  <div class="flex items-center justify-center space-x-4 mb-6">
    <button
      onclick="refreshStatus()"
      class="px-4 py-2 bg-primary text-white rounded-lg shadow hover:bg-blue-700 transition flex items-center"
    >
      <i class="fas fa-sync-alt mr-2"></i> Refresh Now
    </button>
    <button
      onclick="forceCheck()"
      class="px-4 py-2 bg-secondary text-white rounded-lg shadow hover:bg-blue-800 transition flex items-center"
    >
      <i class="fas fa-stethoscope mr-2"></i> Force Health Check
    </button>
    <button
      onclick="rollback()"
      class="px-4 py-2 bg-danger text-white rounded-lg shadow hover:bg-red-600 transition flex items-center"
    >
      <i class="fas fa-undo mr-2"></i> ROLLBACK
    </button>
  </div>

  <!-- Services Grid -->
  <div id="services" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <!-- Services will be loaded here -->
  </div>

  <!-- Last Updated -->
  <p id="last-updated" class="text-center text-sm text-gray-500">
    Last updated: {{ last_updated }}
  </p>
</div>
{% endblock %}

{% block scripts %}
<script>
  function updateDashboard(data) {
    // Update summary
    const summaryDiv = document.getElementById('summary');
    const services = data.services || {};
    const healthyCount = Object.values(services).filter(s => s.status === 'healthy').length;
    const totalCount = Object.keys(services).length;

    let overallStatus, statusClass, borderColor, iconClass;
    if (totalCount === 0) {
      overallStatus = 'No Services Configured';
      statusClass = 'text-gray-500';
      borderColor = 'border-gray-400';
      iconClass = 'fa-question-circle';
    } else if (healthyCount === totalCount) {
      overallStatus = 'All Systems Operational';
      statusClass = 'text-success';
      borderColor = 'border-success';
      iconClass = 'fa-check-circle';
    } else if (healthyCount === 0) {
      overallStatus = 'System Down';
      statusClass = 'text-danger';
      borderColor = 'border-danger';
      iconClass = 'fa-times-circle';
    } else {
      overallStatus = 'Degraded Performance';
      statusClass = 'text-yellow-500';
      borderColor = 'border-yellow-500';
      iconClass = 'fa-exclamation-triangle';
    }

    summaryDiv.className = `bg-white rounded-xl shadow-lg p-6 mb-6 border-l-4 ${borderColor}`;
    summaryDiv.innerHTML = `
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-2xl font-bold ${statusClass} flex items-center">
            <i class="fas ${iconClass} mr-2"></i>
            ${overallStatus}
          </h3>
          <p class="text-gray-600 mt-1">${healthyCount} of ${totalCount} services healthy</p>
        </div>
        <div class="text-4xl ${statusClass}">
          <i class="fas ${iconClass}"></i>
        </div>
      </div>
    `;

    // Update services
    const servicesDiv = document.getElementById('services');
    servicesDiv.innerHTML = '';

    const statusConfig = {
      healthy: {
        color: 'border-success',
        textColor: 'text-success',
        bgColor: 'bg-green-50',
        icon: 'fa-check-circle'
      },
      unhealthy: {
        color: 'border-danger',
        textColor: 'text-danger',
        bgColor: 'bg-red-50',
        icon: 'fa-times-circle'
      },
      down: {
        color: 'border-danger',
        textColor: 'text-danger',
        bgColor: 'bg-red-50',
        icon: 'fa-times-circle'
      },
      timeout: {
        color: 'border-yellow-500',
        textColor: 'text-yellow-600',
        bgColor: 'bg-yellow-50',
        icon: 'fa-clock'
      },
      error: {
        color: 'border-danger',
        textColor: 'text-danger',
        bgColor: 'bg-red-50',
        icon: 'fa-exclamation-circle'
      },
      unknown: {
        color: 'border-gray-400',
        textColor: 'text-gray-500',
        bgColor: 'bg-gray-50',
        icon: 'fa-question-circle'
      }
    };

    for (const [name, status] of Object.entries(services)) {
      const config = statusConfig[status.status] || statusConfig.unknown;

      const card = document.createElement('div');
      card.className = `bg-white rounded-xl shadow-lg p-6 border-l-4 ${config.color} ${config.bgColor}`;

      card.innerHTML = `
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center">
            <span class="indicator inline-block w-3 h-3 rounded-full ${config.textColor.replace('text-', 'bg-')} mr-2"></span>
            <h4 class="text-lg font-bold text-gray-800">${name}</h4>
          </div>
          <i class="fas ${config.icon} text-2xl ${config.textColor}"></i>
        </div>

        <div class="mb-4">
          <span class="inline-block px-3 py-1 text-sm font-semibold ${config.textColor} ${config.bgColor} rounded-full uppercase">
            ${status.status}
          </span>
        </div>

        <div class="space-y-2 text-sm text-gray-600">
          <div class="flex justify-between">
            <span class="font-medium">Response Time:</span>
            <span class="font-mono">${status.response_time ? status.response_time + ' ms' : 'N/A'}</span>
          </div>
          <div class="flex justify-between">
            <span class="font-medium">Last Check:</span>
            <span class="font-mono text-xs">${status.last_check || 'Never'}</span>
          </div>
        </div>
      `;
      servicesDiv.appendChild(card);
    }

    // Update timestamp
    document.getElementById('last-updated').textContent = `Last updated: ${data.timestamp}`;
  }

  async function refreshStatus() {
    try {
      const response = await fetch('/api/status');
      const data = await response.json();
      updateDashboard(data);
      showNotification('Success', 'Status refreshed successfully', 'success');
    } catch (error) {
      console.error('Failed to fetch status:', error);
      showNotification('Error', 'Failed to refresh status', 'error');
    }
  }

  async function forceCheck() {
    try {
      showNotification('Info', 'Running health checks...', 'info');
      const response = await fetch('/api/check');
      await response.json();
      await refreshStatus();
      showNotification('Success', 'Health check completed', 'success');
    } catch (error) {
      console.error('Failed to force check:', error);
      showNotification('Error', 'Failed to run health check', 'error');
    }
  }

  async function rollback() {
    if (!confirm('Are you sure you want to rollback to the previous version? This action cannot be undone.')) {
      return;
    }

    try {
      showNotification('Info', 'Starting rollback...', 'info');
      const response = await fetch('/api/rollback', {method: 'POST'});
      const data = await response.json();

      if (!response.ok || data.status !== 'success') {
        showNotification('Error', 'Rollback failed: ' + (data.error || 'Unknown error'), 'error');
      } else {
        showNotification('Success', 'Rollback completed successfully!', 'success');
      }
      await refreshStatus();

    } catch (error) {
      console.error('Rollback error:', error);
      showNotification('Error', 'Rollback failed: ' + error.message, 'error');
    }
  }

  // Initial load
  refreshStatus();

  // Auto-refresh every 30 seconds
  setInterval(refreshStatus, 30000);
</script>
{% endblock %}
