{% extends "layout.html" %}
{% block title %}Rates Management - Billing{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="bg-white rounded-xl shadow-lg overflow-hidden">

    <!-- Header -->
    <div class="bg-slate-800 p-6 text-white">
      <h2 class="text-2xl font-bold flex items-center">
        <i class="fas fa-coins mr-3 text-primary"></i> Billing Rates
      </h2>
      <p class="text-gray-400 text-sm mt-1">
        Upload and download pricing rate tables.
      </p>
    </div>

    <div class="p-8">

      <!-- UPLOAD SECTION -->
      <h3 class="text-xl font-semibold mb-4 flex items-center">
        <i class="fas fa-upload mr-2 text-primary"></i> Upload Rates File
      </h3>

      <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
        <p class="text-sm text-blue-700">
          Upload an Excel file (<strong>.xlsx</strong>) that already exists in <code>/app/in</code>.
        </p>
        <p class="text-sm text-blue-600 mt-1">
          Example: <code>rates.xlsx</code>
        </p>
      </div>

      <form id="ratesUploadForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            File name (inside /in folder)
          </label>
          <input id="rateFilename"
                 type="text"
                 placeholder="rates.xlsx"
                 class="w-full p-2 border rounded-md focus:ring-primary focus:border-primary" />
        </div>

        <button type="submit"
                class="w-full py-3 px-4 bg-primary text-white rounded-md hover:bg-blue-700 shadow transition">
          <i class="fas fa-upload mr-2"></i> Upload Rates
        </button>
      </form>

      <hr class="my-8" />

      <!-- DOWNLOAD SECTION -->
      <h3 class="text-xl font-semibold mb-4 flex items-center">
        <i class="fas fa-download mr-2 text-primary"></i> Download Latest Rates
      </h3>

      <div>
        <button onclick="downloadLatestRates()"
                class="w-full py-3 px-4 bg-slate-700 text-white rounded-md hover:bg-slate-800 shadow transition">
          <i class="fas fa-file-excel mr-2"></i> Download latest_rates.xlsx
        </button>
      </div>

      <!-- STATUS MESSAGES -->
      <div id="successMsg"
           class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-md text-green-700 font-medium">
      </div>

      <div id="errorMsg"
           class="hidden mt-6 p-4 bg-red-50 border border-red-200 rounded-md text-red-700 font-medium">
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // POST /rates
  document.getElementById("ratesUploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const filename = document.getElementById("rateFilename").value.trim();
    if (!filename) {
      showNotification("Error", "Please enter a filename", "error");
      return;
    }

    try {
      const res = await fetch("/rates", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename })
      });

      const data = await res.json();

      if (!res.ok) {
        document.getElementById("errorMsg").classList.remove("hidden");
        document.getElementById("errorMsg").textContent = data.error;
        showNotification("Error", data.error, "error");
        return;
      }

      document.getElementById("successMsg").classList.remove("hidden");
      document.getElementById("successMsg").textContent = data.message;
      showNotification("Success", "Rates uploaded successfully", "success");

    } catch (err) {
      showNotification("Error", err.message, "error");
    }
  });

  // GET /rates
  function downloadLatestRates() {
    window.location.href = "/rates";
  }
</script>
{% endblock %}
